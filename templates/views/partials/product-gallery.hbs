{{# ifCond product.gallery.length '>' 1}}
    <div class="{{class}}">
        <div class="row" style="margin-top: 5px; margin-bottom: 15px">
            <div class="col-xs-12">
                <div class="btn-group" data-toggle="buttons">
					{{#everyNth product.gallery product.imagesPerColorSwatch}}
						{{#if isModZero}}
                        <div data-image-id="#product-{{n}}" class="image-toggler" style="float:left;">
							<img src="{{cloudinaryUrl this width=80}}"/>
						</div>
						{{/if}}
					{{/everyNth}}

                </div>
            </div>
        </div>
    </div>
    <script type="text/javascript">
        $(document).ready(function () {
            function findBootstrapEnvironment() {
                var envs = ['xs', 'sm', 'md', 'lg'];

                var $el = $('<div>');
                $el.appendTo($('body'));

                for (var i = envs.length - 1; i >= 0; i--) {
                    var env = envs[i];

                    $el.addClass('hidden-'+env);
                    if ($el.is(':hidden')) {
                        $el.remove();
                        return env;
                    }
                }
            }


            var imagesPerSwatch = 3;
			{{#if product.imagesPerColorSwatch}}
            	imagesPerSwatch = {{product.imagesPerColorSwatch}};
			{{/if}}
			var colorways = [];
			{{#if product.colorwaysArray}}
                colorways = {{{json product.colorwaysArray}}};
			{{/if}}
			//client-side init gallery;
			var gallery = [];
			//server-side render code to populate gallery.
			{{#each product.gallery}}
				gallery.push("{{{cloudinaryUrl this height=80}}}");
			{{/each}}
			
			var showPopup = false;
			if(findBootstrapEnvironment() !== 'xs' && findBootstrapEnvironment() !== 'sm'){
				showPopup = true;
			}
            for (var i = 0; i < gallery.length + imagesPerSwatch; i+=imagesPerSwatch) {
				// Construct popover html
                var content = '<div class="hidden-xs hidden-sm" style="width:' + (imagesPerSwatch) * 80 + 'px; height:80px;">';
				
				for (var j = i; j < i+imagesPerSwatch; j++) {
					//thisGallery.push(gallery[i]);
					content += '<img style="width:80px;" class="image-toggler-popover" data-image-id="#product-' + j + '" src="' + gallery[j] + '"/>';
				}
                colorways.forEach(function(colorway){
                    if(colorway.productIndex !== undefined && colorway.productIndex == i) {
                        content += '<div class="colorway">' + colorway.color + '</div>';
                    }
                });
				content += '</div>';
				//console.log('productIndex:', swatch.productIndex );
                $("[data-image-id='#product-" + i + "']").popover({
                    //title: 'Look! A bird!',
                    content: content,
                    html: true,
                    placement: 'top',
                    trigger: 'manual'
                }).on("mouseenter", function (e) {
                    var _this = this;
                    $('.image-toggle').hide();
					
                    $($(this).attr('data-image-id')).show();
					
					$(this).popover("show");
					
                    $('.image-toggler-popover').click(function (e) {
                        $('.image-toggle').hide();
                        $($(this).attr('data-image-id')).show();
						
                        /*setTimeout(function () {
							$(_this).popover("hide")
                        }, 1000);*/
                    });
                    
                    $(this).siblings(".popover").on("mouseleave", function () {
                        $(_this).popover('hide');
                    });
                }).on("mouseleave", function () {
                    var _this = this;
                    setTimeout(function () {
                        if (!$(".popover:hover").length) {
                            $(_this).popover("hide")
                        }
                    }, 100);
                }).on("click", function (event) {
                    var _this = this;
                    setTimeout(function () {
                        $(_this).popover("hide")
                    }, 200);
                });
				
			};
            /*$('.image-toggler').click(function (e) {
                $('.image-toggle').hide();
                $($(this).attr('data-image-id')).show();
            });*/

        });
    </script>
{{/ifCond}}
